!function(s){function n(){}function c(e,t){var n,r,o,i=[];for(n in e)!e.hasOwnProperty(n)||"string"==typeof e[n]&&e[n].length<1||(r=t?t+"["+n+"]":n,o=e[n],i.push("object"==typeof o?c(o,r):encodeURIComponent(r)+"="+encodeURIComponent(o)));return i.join("&")}function r(n,r){t(n._opts,n._authentication,function(e,t){if(e||!t||!t.token)return e=e||new Error("No token found!"),"string"==typeof r?n._emitter.emit(r,e):r(e);n._token=t.token,n._socket=new s.SockJS(n._apiRoute+n._socketPrefix,null,n._sockjs),n._socket.onopen=function(){n._monitor.sendMessage({rpc:"auth",token:n._token},function(e,t){r="string"==typeof r?n._emitter.emit.bind(n._emitter,r):r,e?r(e):(delete n._closed,clearInterval(n._connectTimer),delete n._connectTimer,n._connectDelay=i,h(n),r())})},n._monitor=new f(n._socket,n._emitter),n._socket.onmessage=function(e){try{e.data=JSON.parse(e.data)}catch(e){return}e.data.internal?l(n,e.data.command,e.data.data):n._monitor.handleResponse(e.data)},n._socket.onclose=function(){n._closed=!0,n._reconnect&&p(n)}})}function o(e,t){e._closed?e._queue.push({fn:t}):t()}function e(e,t){var n=this;n._emitter=new EventEmitter,a.forEach(function(e){n[e]=n._emitter[e]}),n._closed=!0,e=e||{},n._ready||"function"!=typeof e.ready||n.ready(e.ready),n._onreconnect||"function"!=typeof e.onreconnect||n.onreconnect(e.onreconnect),e.host||(e.host=s.location.host),n._reconnect=void 0===e.reconnect||e.reconnect,n._channels={},n._ping=e.ping||!1,n._sockjs=e.sockjs||{},n._apiRoute=e.host.indexOf("http")<0?s.location.protocol+"//"+e.host:e.host,n._socketPrefix=e.socketPrefix||"/sockets",n._tokenPath=e.tokenPath||"/socket/token",n._actions="object"==typeof t?t:{},n._authentication=e.authentication||{},n._queue=[],n._connectDelay=i,n._connectTimer=null,n._opts={method:"GET",url:n._apiRoute+n._tokenPath,dataType:e.host!==s.location.host?"jsonp":"json"},n._ping&&0<n._ping&&(n._pingTimer=setInterval(function(){n._closed||n.rpc("_ping",{})},n._ping)),r(n,"ready")}var i=10,a=["on","addListener","removeListener","removeAllListeners"],u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",f=(Object.size=function(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n},Object.shallowCopy=function(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},Object.keys||(Object.keys=function(){"use strict";var o=Object.prototype.hasOwnProperty,i=!{toString:null}.propertyIsEnumerable("toString"),s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=s.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var t,n,r=[];for(t in e)o.call(e,t)&&r.push(t);if(i)for(n=0;n<c;n++)o.call(e,s[n])&&r.push(s[n]);return r}}()),function(e,t){this._socket=e,this._inTransit={},this._emitter=t}),l=(f.prototype.sendMessage=function(e,t){(e="string"==typeof e?JSON.parse(e):e).uuid=function(){for(var e="",t=0;t<10;t++)e+=u.charAt(Math.random()*u.length|0);return e}(),this._inTransit[e.rpc]||(this._inTransit[e.rpc]={}),this._inTransit[e.rpc][e.uuid]=t||n,this._socket.send(JSON.stringify(e))},f.prototype.callCallback=function(e){var t=null;(t=e.rpc&&e.uuid?this._inTransit[e.rpc][e.uuid]:t)&&"function"==typeof t&&(e.error?t(e.error):t(null,e.resp),delete this._inTransit[e.rpc][e.uuid],0===Object.size(this._inTransit[e.rpc])&&delete this._inTransit[e.rpc])},f.prototype.handleResponse=function(e){this.callCallback(e),e.channel&&this._emitter.emit("message",e.channel,e.message)},function(i,e,s){var t;"subscribe"===e?(i._channels[s.channel]=!0,i._monitor.callCallback(s)):"unsubscribe"===e?delete i._channels[s.channel]:"rpc"===e&&(t=i._actions,s.command.split(".").forEach(function(e){t=t&&t[e]?t[e]:null}),t&&"function"==typeof t&&t(s.args,function(e,t){var n,r,o;t=t,n=i,r=s,o={},(e=e)?o.error=e.message||e:o.data=t,e={rpc:"_rpc",fid:r.fid,resp:o},n._socket.send(JSON.stringify(e))}))}),p=function(e){e._connectTimer=setTimeout(function(t){r(t,function(e){e?(t._emitter.emit("reconnect",e),p(t)):t._emitter.emit("reconnect")})},e._connectDelay,e),e._connectDelay=(e=e._connectDelay,Math.min(5*e,5e3))},t=function(e,t,n){var r,o,i;(e=Object.shallowCopy(e)).dataType&&"jsonp"===e.dataType.toLowerCase()?(r="token_callback_"+(new Date).getTime()+"_"+Math.round(1e16*Math.random()).toString(36),o=s.document.createElement("script"),s[r]=function(t){if(s.document.body.removeChild(o),delete s[r],"string"==typeof t)try{t=JSON.parse(t)}catch(e){return n(new Error(t||"Error making jsonp request!"))}n(t&&t.error?t.error:null,t)},o.onerror=function(e){return s.document.body.removeChild(o),delete s[r],n(new Error("Error making jsonp request!")),!1},o.onload=function(e){return!1},o.src=e.url+(0<e.url.indexOf("?")?"&":"?")+"callback="+r+"&"+c(t||{}),s.document.body.appendChild(o)):(i=new s.XMLHttpRequest,e.url+=(t&&0<e.url.indexOf("?")?"&":"?")+c(t||{}),i.open(e.method,e.url,!0),i.onreadystatechange=function(){if(4===i.readyState){var e=(i.target||i).responseText;try{e=JSON.parse(e)}catch(e){}200<=i.status&&i.status<300?n(null,e):n(e&&e.error?new Error(e.error):e instanceof Error?e:new Error(e||"Error making HTTP request"))}},i.setRequestHeader("Accept","application/json"),i.send())},h=function(e){for(var t in e._channels)e.subscribe(t);e._queue.forEach(function(e){e.fn&&"function"==typeof e.fn&&e.fn()}),e._queue=[]};e.prototype.ready=function(e){this._emitter.on("ready",e)},e.prototype.onreconnect=function(e){this._emitter.on("reconnect",e)},e.prototype.channels=function(){return Object.keys(this._channels)},e.prototype.rpc=function(e,t,n){var r=this;o(r,function(){r._monitor.sendMessage({rpc:e,req:t},n)})},e.prototype.register=function(e){this._actions=e},e.prototype.subscribe=function(e,t){var n=this;o(n,function(){n._channels[e]=!0,n._monitor.sendMessage({rpc:"_subscribe",req:{channel:e}},t)})},e.prototype.unsubscribe=function(e,t){var n=this;o(n,function(){delete n._channels[e],n._monitor.sendMessage({rpc:"_unsubscribe",req:{channel:e}},t)})},e.prototype.publish=function(e,t,n){var r=this;o(r,function(){r._monitor.sendMessage({rpc:"_publish",req:{channel:e,data:t}},n)})},e.prototype.broadcast=function(e,t){var n=this;o(n,function(){n._monitor.sendMessage({rpc:"_broadcast",req:{data:e}},t)})},e.prototype.onmessage=function(e){this._emitter.on("message",e)},e.prototype.end=function(e){this._emitter.removeAllListeners("ready"),this._emitter.removeAllListeners("reconnect"),this._emitter.removeAllListeners("message"),this._closed=!0,this._socket.onclose=e,this._socket.close()},s.TokenSocket=e}("undefined"==typeof window?{}:window),function(){"use strict";function e(){}var t=e.prototype,n=this,r=n.EventEmitter;function i(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function o(e){return function(){return this[e].apply(this,arguments)}}t.getListeners=function(e){var t,n,r=this._getEvents();if(e instanceof RegExp)for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},t.flattenListeners=function(e){for(var t=[],n=0;n<e.length;n+=1)t.push(e[n].listener);return t},t.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},t.addListener=function(e,t){var n,r=this.getListenersAsObject(e),o="object"==typeof t;for(n in r)r.hasOwnProperty(n)&&-1===i(r[n],t)&&r[n].push(o?t:{listener:t,once:!1});return this},t.on=o("addListener"),t.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},t.once=o("addOnceListener"),t.defineEvent=function(e){return this.getListeners(e),this},t.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},t.removeListener=function(e,t){var n,r,o=this.getListenersAsObject(e);for(r in o)o.hasOwnProperty(r)&&-1!==(n=i(o[r],t))&&o[r].splice(n,1);return this},t.off=o("removeListener"),t.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},t.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},t.manipulateListeners=function(e,t,n){var r,o,i=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(r=n.length;r--;)i.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(o=t[r])&&("function"==typeof o?i:s).call(this,r,o);return this},t.removeEvent=function(e){var t,n=typeof e,r=this._getEvents();if("string"==n)delete r[e];else if(e instanceof RegExp)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},t.removeAllListeners=o("removeEvent"),t.emitEvent=function(e,t){var n,r,o,i,s=this.getListenersAsObject(e);for(i in s)if(s.hasOwnProperty(i))for(o=(n=s[i].slice(0)).length;o--;)!0===(r=n[o]).once&&this.removeListener(e,r.listener),r.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},t.trigger=o("emitEvent"),t.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},t.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},t._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},t._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return n.EventEmitter=r,e},"function"==typeof define&&define.amd?define(function(){return e}):"object"==typeof module&&module.exports?module.exports=e:n.EventEmitter=e}.call(this);